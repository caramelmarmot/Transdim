@page "/game/{GameId}"
@inject Transdim.Service.IBaseGameController BaseGameController
@inject IModalService ModalService;

@using Transdim.Pages.Game.Log;
@using Transdim.Pages.Game.ScoreTracker;
@using Transdim.Pages.Game.Actions;

    <div class="container">
        <ScoreTrackerComponent Game="@game"></ScoreTrackerComponent>

        <div class="row">
            <div class="col-12">Here's the game</div>
            <button class="btn btn-primary" onclick="@DoAnAction">Do an action</button>
            <button class="btn btn-primary" onclick="@ShowModal">ShowModal</button>
        </div>
    </div>
    <footer class="footer">
        <div class="container">
            <GameLog Game="@game"></GameLog>
        </div>
    </footer>

@functions {
    [Parameter]
    private string GameId { get; set; }

    private Game game;

    protected override void OnInit()
    {
        game = BaseGameController.GetGame(new Guid(GameId));

        SetActivePlayerInACrappyWay();
        base.OnInit();
    }

    // TODO: Less crappy!
    void SetActivePlayerInACrappyWay() {
        game.Players.First(p => p.Id == game.Rounds[0].OrderedPlayerIds[0]).IsActive = true;
    }

    void DoAnAction()
    {
        var player = game.Players.First(p => p.IsActive == true);

        var random = new Random();
        int randomNumber = random.Next(1, 4);

        game.GameActions.Add(new GameAction {
            Player = player,
            Points = randomNumber,
            LogText = $"Player {player.FactionIdentifier} did a thing and got {randomNumber} points" });

        // TODO: Encapsulate active player selection and keep it from always being 
        var nextPlayerIndex = game.Players.IndexOf(player) + 1;
        if (nextPlayerIndex > game.Players.Count - 1)
        {
            nextPlayerIndex = 0;
        }

        player.IsActive = false;
        game.Players[nextPlayerIndex].IsActive = true;
    }

    void ShowModal()
    {
        ModalService.OnClose += ModalClosed;
        ModalService.Show("Power Action", typeof(PowerActionComponent));
    }

    void ModalClosed(ModalResult modalResult)
    {
        ModalService.OnClose -= ModalClosed;

        if (modalResult.Cancelled)
        {
            Console.WriteLine("Modal was cancelled");
        }
        else
        {
            Console.WriteLine(modalResult.Data);
        }
    }
}
